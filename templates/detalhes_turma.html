{% extends "base.html" %}

{% block title %}Detalhes da Turma - {{ turma.nome }}{% endblock %}

{% block content %}
<div class="content-header">
    <h1>{{ turma.nome }}</h1>
    <p>Gerencie os alunos e as disciplinas desta turma.</p>
</div>

<div class="turma-details-grid">
    <div class="details-section">
        <div class="section-header">
            <h3>Alunos na Turma ({{ turma.alunos|length }})</h3>
            {% if current_user.role in ['admin', 'programador'] %}
            <div class="header-actions">
                <button type="button" class="btn btn-sm btn-danger" id="btn-remover-selecionados" disabled>Remover Selecionados</button>
                <a href="{{ url_for('turma.adicionar_alunos_turma_pagina', turma_id=turma.id) }}" class="btn btn-sm btn-primary">Adicionar Aluno</a>
            </div>
            {% endif %}
        </div>
        <form id="form-remover-alunos" method="POST" action="{{ url_for('turma.remover_alunos_turma', turma_id=turma.id) }}">
            <div class="aluno-list">
                {% for aluno in turma.alunos %}
                <div class="aluno-item">
                    {% if current_user.role in ['admin', 'programador'] %}
                    <input type="checkbox" name="aluno_ids" value="{{ aluno.id }}" class="aluno-checkbox">
                    {% endif %}
                    <div class="aluno-avatar">
                        <img src="{{ url_for('static', filename='uploads/' + (aluno.foto_perfil or 'default.png')) }}" alt="Foto do Aluno">
                    </div>
                    <div class="aluno-info">
                        <strong>{{ aluno.user.nome_completo or aluno.user.username }}</strong>
                        <span>Matrícula: {{ aluno.matricula }}</span>
                    </div>
                    {% if current_user.role in ['admin', 'programador'] %}
                    <div class="aluno-actions">
                        <div class="dropdown">
                            <button type="button" class="btn-icon">⋮</button>
                            <div class="dropdown-menu">
                                <a href="{{ url_for('aluno.editar_aluno', aluno_id=aluno.id) }}">Editar Perfil</a>
                                <a href="{{ url_for('historico.historico_aluno', aluno_id=aluno.id) }}">Ver Histórico</a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-muted">Nenhum aluno cadastrado nesta turma.</p>
                {% endfor %}
            </div>
        </form>
    </div>

    <div class="details-section">
        <div class="section-header">
            <h3>Disciplinas e Instrutores</h3>
        </div>
        {% if current_user.role in ['admin', 'programador'] %}
        <form method="POST" action="{{ url_for('turma.editar_disciplinas_turma', turma_id=turma.id) }}">
            <div class="disciplina-list">
                {% for dt in disciplinas_turma %}
                <div class="disciplina-item">
                    <div class="disciplina-info">
                        <strong>{{ dt.disciplina.materia }}</strong>
                    </div>
                    <div class="instrutor-fields">
                        <div class="form-group">
                            <label>Instrutor 1</label>
                            <select name="instrutor1_{{ dt.disciplina.id }}" class="form-control">
                                <option value="">-- Selecione --</option>
                                {% for instrutor in instrutores %}
                                <option value="{{ instrutor.id }}" {% if dt.instrutor_id_1 == instrutor.id %}selected{% endif %}>
                                    {{ instrutor.user.nome_completo or instrutor.user.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% if dt.disciplina.materia in disciplinas_com_dois_instrutores %}
                        <div class="form-group">
                            <label>Instrutor 2 (Opcional)</label>
                            <select name="instrutor2_{{ dt.disciplina.id }}" class="form-control">
                                <option value="">-- Selecione --</option>
                                {% for instrutor in instrutores %}
                                <option value="{{ instrutor.id }}" {% if dt.instrutor_id_2 == instrutor.id %}selected{% endif %}>
                                    {{ instrutor.user.nome_completo or instrutor.user.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="form-actions">
                <a href="{{ url_for('turma.listar_turmas') }}" class="btn btn-secondary">Voltar</a>
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </form>
        {% else %}
        <div class="disciplina-list">
            {% for dt in disciplinas_turma %}
            <div class="disciplina-item-readonly">
                <strong>{{ dt.disciplina.materia }}</strong>
                <span class="instrutor-readonly">
                    {% if dt.instrutor_1 %}
                        {{ dt.instrutor_1.user.nome_completo or dt.instrutor_1.user.username }}
                    {% else %}
                        (Instrutor a definir)
                    {% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

<style>
/* Estilos existentes... */
.disciplina-item-readonly {
    padding: 1rem;
    border-bottom: 1px solid #f1f5f9;
}
.disciplina-item-readonly strong {
    display: block;
    font-weight: 600;
}
.instrutor-readonly {
    color: var(--color-text-muted);
    font-size: 0.9rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // O script só precisa rodar para admins
    {% if current_user.role in ['admin', 'programador'] %}
    // Gerenciamento da Remoção de Alunos
    const checkboxes = document.querySelectorAll('.aluno-checkbox');
    const btnRemover = document.getElementById('btn-remover-selecionados');
    const formRemover = document.getElementById('form-remover-alunos');

    if (checkboxes.length > 0 && btnRemover && formRemover) {
        function toggleRemoverButton() {
            const algumSelecionado = Array.from(checkboxes).some(cb => cb.checked);
            btnRemover.disabled = !algumSelecionado;
        }
        
        checkboxes.forEach(cb => cb.addEventListener('change', toggleRemoverButton));
        
        btnRemover.addEventListener('click', () => {
            if (confirm('Tem certeza que deseja remover os alunos selecionados desta turma?')) {
                formRemover.submit();
            }
        });
    }

    // Gerenciamento dos Menus Dropdown "3 pontos"
    const dropdownButtons = document.querySelectorAll('.dropdown .btn-icon');
    if (dropdownButtons.length > 0) {
        dropdownButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = button.closest('.dropdown');
                
                document.querySelectorAll('.dropdown.active').forEach(d => {
                    if (d !== dropdown) {
                        d.classList.remove('active');
                    }
                });
                
                dropdown.classList.toggle('active');
            });
        });
        
        document.addEventListener('click', () => {
            document.querySelectorAll('.dropdown.active').forEach(d => d.classList.remove('active'));
        });
    }
    {% endif %}
});
</script>
{% endblock %}